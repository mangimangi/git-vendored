{"id":"gv-d942","title":"Refactor install into add + update","status":"open","issue_type":"epic","priority":2,"created_at":"2026-02-10T04:38:09Z"}
{"id":"gv-d942.1","title":"Rename vendored/install to vendored/update","status":"open","issue_type":"task","priority":2,"created_at":"2026-02-10T04:48:39Z","parent":"gv-d942","body":"Rename the install script to update, reflecting that it only operates on already-registered vendors.\n\n## Scope\n\n- Rename `vendored/install` \u2192 `vendored/update`\n- Rename `tests/test_install.py` \u2192 `tests/test_update.py`\n- Update internal references in the test file (dynamic import path, module name)\n- Improve unknown-vendor error to list registered vendors:\n  ```\n  ::error::Unknown vendor: typo-name\n  Registered vendors: git-vendored, git-semver, git-dogfood, pearls\n  ```\n\n## Acceptance Criteria\n\n- [ ] `vendored/install` no longer exists; `vendored/update` exists with identical logic\n- [ ] `tests/test_install.py` no longer exists; `tests/test_update.py` exists\n- [ ] All tests pass after the rename (dynamic import path and any internal references updated)\n- [ ] Unknown vendor error message includes a list of registered vendor names from config\n- [ ] No other files reference the old `vendored/install` path (except install.sh and workflow template \u2014 those are handled in later issues)","deps":[{"id":"gv-d942.2","type":"blocks"},{"id":"gv-d942.5","type":"blocks"}]}
{"id":"gv-d942.2","title":"Write GITHUB_OUTPUT directly from Python in vendored/update","status":"open","issue_type":"task","priority":2,"created_at":"2026-02-10T04:48:56Z","parent":"gv-d942","body":"Have vendored/update write workflow outputs directly to $GITHUB_OUTPUT instead of relying on fragile grep/cut/python stdout parsing in the workflow shell step.\n\n## Scope\n\n**Edit `vendored/update`:**\n- When `$GITHUB_OUTPUT` env var is set, write key=value pairs to that file:\n  - Single-vendor mode: `vendor`, `old_version`, `new_version`, `changed`, `install_branch`\n  - All-vendors mode: `changed_vendors` (JSON), `changed_count`\n- Continue printing human-readable stdout output (useful for local runs and logs)\n\n**Edit `templates/github/workflows/install-vendored.yml`:**\n- Remove the grep/cut/python one-liner parsing of stdout\n- Reference step outputs directly (e.g., `steps.update.outputs.changed`)\n\n**Edit `tests/test_update.py`:**\n- Add tests that verify GITHUB_OUTPUT file is written correctly when the env var is set\n- Add tests that verify no GITHUB_OUTPUT file is written when the env var is not set\n- Existing stdout-based tests should still pass (human-readable output preserved)\n\n## Acceptance Criteria\n\n- [ ] `vendored/update` writes key=value pairs to `$GITHUB_OUTPUT` file when env var is set\n- [ ] Stdout output is preserved for human readability\n- [ ] Workflow template no longer parses stdout \u2014 uses step outputs directly\n- [ ] `tests/test_update.py` includes tests for GITHUB_OUTPUT writing (set and unset)\n- [ ] All existing tests pass","deps":[{"id":"gv-d942.1","type":"blocked_by"},{"id":"gv-d942.3","type":"precedes"}]}
{"id":"gv-d942.3","title":"Fix workflow token leaking and automerge default","status":"open","issue_type":"task","priority":2,"created_at":"2026-02-10T04:49:13Z","parent":"gv-d942","body":"Fix two issues in the workflow template: VENDOR_PAT leaking into PR creation, and automerge defaulting to true.\n\n## Scope\n\n**Token fix in `templates/github/workflows/install-vendored.yml`:**\n- Update step uses VENDOR_PAT (for private repo downloads): `GH_TOKEN: ${{ secrets.token || secrets.VENDOR_PAT || github.token }}`\n- PR creation step always uses github.token: `GH_TOKEN: ${{ github.token }}`\n- This prevents a PAT scoped for private repo reads from being used for PR operations on public vendors\n\n**Automerge default fix:**\n- Default automerge to `false` in the workflow\n- Only automerge when the vendor's config explicitly has `\"automerge\": true`\n- Document the default in the config shape\n\n**PR creation improvements:**\n- Add `--head \"$BRANCH\"` to `gh pr create` command\n- Handle \"PR already exists\" case gracefully (don't fail the workflow)\n\n## Acceptance Criteria\n\n- [ ] PR creation step uses `${{ github.token }}`, not VENDOR_PAT\n- [ ] Update/download step retains VENDOR_PAT for private repo access\n- [ ] Automerge defaults to `false` \u2014 only enabled when vendor config has `\"automerge\": true`\n- [ ] `gh pr create` includes `--head` flag with the branch name\n- [ ] Workflow does not fail if a PR already exists for the branch\n- [ ] All existing tests pass","deps":[{"id":"gv-d942.2","type":"follows"}]}
{"id":"gv-d942.4","title":"Create vendored/add command","status":"open","issue_type":"task","priority":2,"created_at":"2026-02-10T04:49:44Z","parent":"gv-d942","body":"New command for first-time vendor registration. Run locally by the user (not by workflows).\n\n## Scope\n\n**New file: `vendored/add`**\n\nUsage: `python3 .vendored/add <owner/repo> [--name <name>]`\n\nFlow:\n1. **Pre-validate** the target repo:\n   - Confirm `install.sh` exists at repo root (via `gh api repos/{owner/repo}/contents/install.sh`)\n   - Confirm version is resolvable (GitHub Releases API or VERSION file fallback)\n   - Fail with \"repo does not implement git-vendored\" if either is missing\n2. **Snapshot** `.vendored/config.json` (before state)\n3. **Run** the vendor's `install.sh` (download and execute with resolved version)\n4. **Post-validate** the config entry the vendor registered:\n   - Diff config before/after to find the new entry\n   - Required fields: `repo`, `protected`, `install_branch`\n   - Fail if `install.sh` didn't register itself\n5. **Output** summary of what was added (vendor name, version, registered files)\n\nError cases:\n- Repo doesn't exist or is inaccessible \u2192 error with auth hint\n- No `install.sh` found \u2192 \"repo does not implement git-vendored\"\n- `install.sh` didn't write a config entry \u2192 \"install.sh must self-register\"\n- Vendor already registered \u2192 error suggesting to use update instead\n\n**New file: `tests/test_add.py`**\n\nFollow existing test patterns: dynamic module import, `tmp_repo` + `make_config` fixtures, `monkeypatch` for env vars, `unittest.mock.patch` for subprocess calls.\n\n### Test Plan\n\n**TestPreValidate:**\n- `test_repo_with_install_sh_passes` \u2014 Mock GitHub API returns install.sh \u2192 no error\n- `test_repo_without_install_sh_fails` \u2014 Mock API returns 404 \u2192 exits with \"does not implement git-vendored\"\n- `test_repo_not_found_fails` \u2014 Mock API returns 404 for repo \u2192 exits with auth hint\n- `test_version_resolvable_from_releases` \u2014 Mock releases API returns tag \u2192 version resolved\n- `test_version_resolvable_from_version_file` \u2014 Mock releases fails, VERSION file fallback works\n- `test_version_not_resolvable_fails` \u2014 Both methods fail \u2192 exits with error\n\n**TestSnapshotAndDiff:**\n- `test_detects_new_config_entry` \u2014 Config before has 1 vendor, after has 2 \u2192 new entry found\n- `test_no_new_entry_fails` \u2014 Config unchanged after install.sh \u2192 exits with \"must self-register\"\n\n**TestPostValidate:**\n- `test_valid_entry_passes` \u2014 New entry has repo, protected, install_branch \u2192 success\n- `test_missing_repo_fails` \u2014 Missing repo \u2192 exits with clear message\n- `test_missing_protected_fails` \u2014 Missing protected \u2192 exits with clear message\n- `test_missing_install_branch_fails` \u2014 Missing install_branch \u2192 exits with clear message\n\n**TestAddVendor (integration):**\n- `test_add_new_vendor` \u2014 Full flow: pre-validate \u2192 run install.sh \u2192 post-validate \u2192 success output\n- `test_add_already_registered_fails` \u2014 Vendor already in config \u2192 exits with \"already registered\"\n- `test_add_with_custom_name` \u2014 `--name` flag overrides vendor key in config lookup\n\n**TestAddOutput:**\n- `test_summary_shows_vendor_name` \u2014 Output includes vendor name\n- `test_summary_shows_version` \u2014 Output includes installed version\n- `test_summary_shows_registered_files` \u2014 Output includes what install.sh added to config\n\n## Acceptance Criteria\n\n- [ ] `vendored/add` exists and is executable\n- [ ] Pre-validates target repo has `install.sh` and resolvable version\n- [ ] Snapshots config, runs vendor's install.sh, then post-validates the new config entry\n- [ ] Post-validation checks for required fields: `repo`, `protected`, `install_branch`\n- [ ] Clear error messages for all failure cases (no install.sh, no version, no self-registration, already registered)\n- [ ] `--name` flag allows overriding the vendor key\n- [ ] `tests/test_add.py` exists with all test cases from the test plan above\n- [ ] All tests pass","deps":[{"id":"gv-d942.5","type":"blocks"}]}
{"id":"gv-d942.5","title":"Update install.sh bootstrap for add/update rename and migration","status":"open","issue_type":"task","priority":2,"created_at":"2026-02-10T04:50:03Z","parent":"gv-d942","body":"Update the bootstrap install.sh to download the new files, clean up the old install script, and patch existing workflow files.\n\n## Scope\n\n**Edit `install.sh`:**\n\nDownload changes:\n- Download `vendored/add` \u2192 `.vendored/add` (new)\n- Download `vendored/update` \u2192 `.vendored/update` (renamed from install)\n- Download `vendored/check` \u2192 `.vendored/check` (unchanged)\n\nMigration cleanup:\n- `rm -f .vendored/install` \u2014 remove the old script from repos that had it installed\n\nWorkflow patching:\n- After downloading files, patch existing workflow files that reference the old path\n- In `.github/workflows/install-vendored.yml`, replace `python3 .vendored/install` with `python3 .vendored/update`:\n  ```bash\n  if [ -f .github/workflows/install-vendored.yml ]; then\n      sed -i 's|python3 \\.vendored/install|python3 .vendored/update|g' \\\n          .github/workflows/install-vendored.yml\n  fi\n  ```\n\nUnchanged:\n- Self-registration logic stays\n- First-install-only guard for workflow templates stays\n\n**Edit `tests/test_installer.py`:**\n- Update tests to verify `.vendored/add` is downloaded and executable\n- Update tests to verify `.vendored/update` is downloaded (not `.vendored/install`)\n- Add test verifying `rm -f .vendored/install` cleanup occurs\n- Add test verifying workflow patching (sed replacement) works\n\n## Acceptance Criteria\n\n- [ ] `install.sh` downloads `vendored/add` \u2192 `.vendored/add`\n- [ ] `install.sh` downloads `vendored/update` \u2192 `.vendored/update`\n- [ ] `install.sh` runs `rm -f .vendored/install` to clean up old script\n- [ ] `install.sh` patches `.github/workflows/install-vendored.yml` to replace old path references\n- [ ] `.vendored/add` and `.vendored/update` are executable after install\n- [ ] `tests/test_installer.py` updated with tests for new download targets, cleanup, and patching\n- [ ] All tests pass","deps":[{"id":"gv-d942.1","type":"blocked_by"},{"id":"gv-d942.4","type":"blocked_by"},{"id":"gv-d942.6","type":"precedes"}]}
{"id":"gv-d942.6","title":"Create project README","status":"open","issue_type":"task","priority":2,"created_at":"2026-02-10T04:50:23Z","parent":"gv-d942","body":"Create a comprehensive but simple README.md for the git-vendored project.\n\n## Scope\n\n**New file: `README.md`**\n\nThe README should cover:\n\n1. **What git-vendored is** \u2014 one-paragraph summary: automated vendor install control for repo-embedded tools via GitHub workflows\n2. **How it works** \u2014 brief explanation of the vendor contract (install.sh + config self-registration + version discovery)\n3. **Quick start** \u2014 how to bootstrap git-vendored in a new repo (run install.sh)\n4. **Adding a vendor** \u2014 usage of `vendored/add` command\n5. **How updates work** \u2014 the automated workflow: schedule/manual trigger \u2192 vendored/update \u2192 PR creation\n6. **Configuration** \u2014 `.vendored/config.json` structure with field descriptions (repo, protected, allowed, install_branch, private, automerge, dogfood)\n7. **Vendor contract** \u2014 what a vendor repo must provide (install.sh at root, version via GitHub Releases or VERSION file, self-registration in config)\n8. **Protection rules** \u2014 how vendored/check enforces protected file patterns\n\nKeep it simple and practical \u2014 favor examples over prose. No need to document internal implementation details.\n\n## Acceptance Criteria\n\n- [ ] `README.md` exists at the repo root\n- [ ] Covers all sections listed above\n- [ ] Reflects the post-refactoring state (add/update commands, not the old install command)\n- [ ] Includes concrete usage examples (commands, config snippets)\n- [ ] Simple and concise \u2014 no unnecessary verbosity","deps":[{"id":"gv-d942.5","type":"follows"}]}
