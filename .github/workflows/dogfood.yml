# .github/workflows/dogfood.yml
# Triggers vendor self-update after a successful Release.
#
# Bridges git-semver (Release event) to git-vendored (install-vendored workflow).
# The .dogfood/resolve script finds the vendor with "dogfood": true in
# .vendored/config.json and triggers install-vendored for that vendor.
#
# Chain: version-bump → release → dogfood → install-vendored → PR → merge

name: Dogfood

on:
  workflow_run:
    workflows: ["Release"]
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  resolve:
    if: github.event.workflow_run.conclusion == 'success'
    runs-on: ubuntu-latest
    outputs:
      vendor: ${{ steps.find.outputs.vendor }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Find dogfood vendor
        id: find
        run: python3 .dogfood/resolve >> $GITHUB_OUTPUT

  install:
    needs: resolve
    if: needs.resolve.outputs.vendor
    uses: ./.github/workflows/install-vendored.yml
    with:
      vendor: ${{ needs.resolve.outputs.vendor }}
      version: latest
