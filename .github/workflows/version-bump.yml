# .github/workflows/version-bump.yml
# Bumps version when implementation files change on merge to main (patch),
# or when triggered manually via workflow_dispatch (major|minor|patch).
#
# Thin wrapper around git-semver — handles triggers and auth,
# the script handles everything else.
#
# Skips automated commits (chore: bump version, chore: install).
# Uses GITHUB_TOKEN — no PAT required for the core versioning flow.

name: Version Bump

on:
  push:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
      changelog_description:
        description: 'Changelog entry (what changed in this release)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: push-to-main
  cancel-in-progress: false

jobs:
  version-bump:
    runs-on: ubuntu-latest
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' &&
       !startsWith(github.event.head_commit.message, 'chore: bump version') &&
       !startsWith(github.event.head_commit.message, 'chore: install'))
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Read on_merge config
        if: github.event_name == 'push'
        id: config
        run: |
          ON_MERGE="true"
          if [ -f .semver/config.json ]; then
            ON_MERGE=$(python3 -c "
          import json
          c = json.load(open('.semver/config.json'))
          print(str(c.get('install', {}).get('on_merge', True)).lower())
          " 2>/dev/null || echo "true")
          fi
          echo "on_merge=$ON_MERGE" >> $GITHUB_OUTPUT

      - name: Check for version-triggering changes
        if: github.event_name == 'push' && steps.config.outputs.on_merge == 'true'
        id: check
        run: |
          BEFORE="${{ github.event.before }}"
          set +e
          .semver/git-semver check --since "$BEFORE"
          rc=$?
          set -e
          if [ $rc -eq 0 ]; then
            echo "triggered=true" >> $GITHUB_OUTPUT
          elif [ $rc -eq 1 ]; then
            echo "triggered=false" >> $GITHUB_OUTPUT
          else
            echo "::error::git-semver check failed with exit code $rc"
            exit $rc
          fi

      - name: Read automerge config
        if: github.event_name == 'workflow_dispatch' || steps.check.outputs.triggered == 'true'
        id: automerge
        run: |
          AUTOMERGE="true"
          if [ -f .semver/config.json ]; then
            AUTOMERGE=$(python3 -c "
          import json
          c = json.load(open('.semver/config.json'))
          print(str(c.get('install', {}).get('automerge', True)).lower())
          " 2>/dev/null || echo "true")
          fi
          echo "automerge=$AUTOMERGE" >> $GITHUB_OUTPUT

      - name: Bump version (direct push)
        if: (github.event_name == 'workflow_dispatch' || steps.check.outputs.triggered == 'true') && steps.automerge.outputs.automerge == 'true'
        env:
          BUMP_TYPE: ${{ inputs.bump_type || 'patch' }}
          DESCRIPTION: ${{ inputs.changelog_description || '' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$DESCRIPTION" ]; then
            .semver/git-semver bump "$BUMP_TYPE" --description "$DESCRIPTION"
          else
            .semver/git-semver bump "$BUMP_TYPE"
          fi

      - name: Bump version (PR mode)
        if: (github.event_name == 'workflow_dispatch' || steps.check.outputs.triggered == 'true') && steps.automerge.outputs.automerge == 'false'
        env:
          BUMP_TYPE: ${{ inputs.bump_type || 'patch' }}
          DESCRIPTION: ${{ inputs.changelog_description || '' }}
          GH_TOKEN: ${{ github.token }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$DESCRIPTION" ]; then
            .semver/git-semver bump "$BUMP_TYPE" --no-push --description "$DESCRIPTION"
          else
            .semver/git-semver bump "$BUMP_TYPE" --no-push
          fi

          VERSION=$(cat VERSION)
          BRANCH="chore/bump-version-v${VERSION}"
          git checkout -b "$BRANCH"
          git push -u origin "$BRANCH"
          gh pr create \
            --title "chore: bump version to v${VERSION}" \
            --body "Automated version bump to v${VERSION}" \
            --base main
