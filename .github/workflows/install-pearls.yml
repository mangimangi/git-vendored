# .github/workflows/install-pearls.yml
# Installs or updates the pearls (prl) issue tracker.
#
# Fetches install.sh from the pearls repo at the TARGET version and runs it.
# This keeps the install logic in sync with the version being installed.
#
# Setup:
#   Add PRL_PAT as a repository secret with these permissions:
#   - On pearls repo: Contents:Read
#   - On this repo: Contents:Write, Pull requests:Write, Workflows:Write
#
# Usage:
#   - Trigger manually from the Actions tab (optionally specify a version)
#   - Runs on a configurable schedule (default: Mondays at 9am UTC)

name: Install Pearls

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to install (or "latest")'
        required: false
        default: 'latest'
  workflow_call:
    inputs:
      version:
        description: 'Version to install (or "latest")'
        required: false
        default: 'latest'
        type: string
    secrets:
      PRL_PAT:
        required: true
  schedule:
    - cron: 'INSTALL_SCHEDULE'

permissions:
  contents: write
  pull-requests: write

env:
  PEARLS_REPO: USER/pearls

jobs:
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PRL_PAT
        env:
          PRL_PAT: ${{ secrets.PRL_PAT }}
        run: |
          if [ -z "$PRL_PAT" ]; then
            echo "::error::PRL_PAT secret is required. Create a fine-grained PAT with:"
            echo "::error::  - On pearls repo: Contents:Read"
            echo "::error::  - On this repo: Contents:Write, Pull requests:Write, Workflows:Write"
            echo "::error::Add it as a repository secret named PRL_PAT."
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PRL_PAT }}

      - name: Resolve target version
        id: version
        env:
          GH_TOKEN: ${{ secrets.PRL_PAT }}
        run: |
          VERSION="${{ inputs.version || 'latest' }}"
          if [ "$VERSION" = "latest" ]; then
            VERSION=$(gh api "repos/$PEARLS_REPO/contents/VERSION" --jq '.content' | base64 -d | tr -d '[:space:]')
          fi
          echo "target=$VERSION" >> $GITHUB_OUTPUT

          CURRENT="none"
          if [ -f .pearls/.prl-version ]; then
            CURRENT=$(cat .pearls/.prl-version | tr -d '[:space:]')
          fi
          echo "current=$CURRENT" >> $GITHUB_OUTPUT

          if [ "$CURRENT" = "$VERSION" ]; then
            echo "Already at v$VERSION"
          else
            echo "Installing: $CURRENT -> $VERSION"
          fi

      - name: Run install script
        env:
          GH_TOKEN: ${{ secrets.PRL_PAT }}
        run: |
          VERSION="${{ steps.version.outputs.target }}"
          gh api "repos/$PEARLS_REPO/contents/install.sh?ref=v$VERSION" --jq '.content' | base64 -d | bash -s "$VERSION" "$PEARLS_REPO"

      - name: Create Pull Request
        id: create-pr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PRL_PAT }}
          commit-message: "chore: install pearls v${{ steps.version.outputs.target }}"
          title: "Install pearls v${{ steps.version.outputs.target }}"
          body: |
            Updates the installed pearls issue tracker.

            **Version:** `${{ steps.version.outputs.current }}` â†’ `${{ steps.version.outputs.target }}`

            See [pearls changelog](https://github.com/${{ env.PEARLS_REPO }}/blob/main/CHANGELOG.md) for details.
          branch: "chore/install-pearls-v${{ steps.version.outputs.target }}"
          delete-branch: true
          labels: |
            dependencies
            automated

      - name: Enable automerge
        if: steps.create-pr.outputs.pull-request-number
        env:
          GH_TOKEN: ${{ secrets.PRL_PAT }}
        run: |
          AUTOMERGE="true"
          if [ -f .pearls/config.json ]; then
            AUTOMERGE=$(python3 -c "import json; c=json.load(open('.pearls/config.json')); print(str(c.get('install',{}).get('automerge', True)).lower())" 2>/dev/null || echo "true")
          fi
          if [ "$AUTOMERGE" = "true" ]; then
            PR_NUMBER="${{ steps.create-pr.outputs.pull-request-number }}"
            echo "Enabling automerge for PR #$PR_NUMBER"
            gh pr merge "$PR_NUMBER" --auto --squash || echo "Could not enable automerge for PR #$PR_NUMBER (repo may need 'Allow auto-merge' enabled in settings)"
          else
            echo "Automerge disabled (install.automerge: false)"
          fi
